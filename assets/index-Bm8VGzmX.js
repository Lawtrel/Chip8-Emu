(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();class K{memory=new Uint8Array(4096);registers=new Uint8Array(16);I=0;pc=512;stack=new Array(16).fill(0);stackPointer=0;keys=new Uint8Array(16);delayTimer=0;soundTimer=0;display=new Array(2048).fill(0);loadRom(e){for(let t=0;t<e.length;t++)this.memory[512+t]=e[t];const r=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];for(let t=0;t<r.length;t++)this.memory[t]=r[t]}cycle(){const e=this.memory[this.pc]<<8|this.memory[this.pc+1];switch(this.pc+=2,e&61440){case 0:(e&255)===224?this.display.fill(0):(e&255)===238&&(this.stackPointer--,this.pc=this.stack[this.stackPointer]);break;case 4096:this.pc=e&4095;break;case 8192:this.stack[this.stackPointer]=this.pc,this.stackPointer++,this.pc=e&4095;break;case 12288:this.registers[(e&3840)>>8]===(e&255)&&(this.pc+=2);break;case 16384:this.registers[(e&3840)>>8]!==(e&255)&&(this.pc+=2);break;case 20480:this.registers[(e&3840)>>8]===this.registers[(e&240)>>4]&&(this.pc+=2);break;case 24576:this.registers[(e&3840)>>8]=e&255;break;case 28672:this.registers[(e&3840)>>8]+=e&255;break;case 32768:const s=(e&3840)>>8,r=(e&240)>>4;switch(e&15){case 0:this.registers[s]=this.registers[r];break;case 1:this.registers[s]|=this.registers[r];break;case 2:this.registers[s]&=this.registers[r];break;case 3:this.registers[s]^=this.registers[r];break;case 4:const a=this.registers[s]+this.registers[r];this.registers[15]=a>255?1:0,this.registers[s]=a&255;break;case 5:this.registers[15]=this.registers[s]>this.registers[r]?1:0,this.registers[s]-=this.registers[r];break;case 6:this.registers[15]=this.registers[s]&1,this.registers[s]>>=1;break;case 7:this.registers[15]=this.registers[r]>this.registers[s]?1:0,this.registers[s]=this.registers[r]-this.registers[s];break;case 14:this.registers[15]=(this.registers[s]&128)>>7,this.registers[s]<<=1;break}break;case 36864:this.registers[(e&3840)>>8]!==this.registers[(e&240)>>4]&&(this.pc+=2);break;case 40960:this.I=e&4095;break;case 45056:this.pc=(e&4095)+this.registers[0];break;case 49152:const t=(e&3840)>>8;this.registers[t]=Math.floor(Math.random()*256)&(e&255);break;case 53248:const n=(e&3840)>>8,h=(e&240)>>4,m=e&15,u=this.registers[n],v=this.registers[h];this.registers[15]=0;for(let a=0;a<m;a++){const F=this.memory[this.I+a];for(let y=0;y<8;y++)if((F&128>>y)!==0){const I=(u+y)%64+(v+a)%32*64;this.display[I]===1&&(this.registers[15]=1),this.display[I]^=1}}break;case 57344:const L=(e&3840)>>8;(e&255)===158?this.keys[this.registers[L]]===1&&(this.pc+=2):(e&255)===161&&this.keys[this.registers[L]]===0&&(this.pc+=2);break;case 61440:const l=(e&3840)>>8;switch(e&255){case 7:this.registers[l]=this.delayTimer;break;case 21:this.delayTimer=this.registers[l];break;case 24:this.soundTimer=this.registers[l];break;case 30:this.I+=this.registers[l];break;case 41:this.I=this.registers[l]*5;break;case 51:this.memory[this.I]=Math.floor(this.registers[l]/100),this.memory[this.I+1]=Math.floor(this.registers[l]%100/10),this.memory[this.I+2]=this.registers[l]%10;break;case 85:for(let a=0;a<=l;a++)this.memory[this.I+a]=this.registers[a];break;case 101:for(let a=0;a<=l;a++)this.registers[a]=this.memory[this.I+a];break}break}}}const w=document.getElementById("screen"),p=w.getContext("2d"),k=10,o=new K;let E,b=0;const N=60,A=1e3/N;let d=null,g=null,f=null;const R=document.getElementById("romSelect"),x=document.getElementById("btnLoad");x.addEventListener("click",()=>{O(),d&&d.state==="suspended"&&d.resume();const i=R.value;M(i)});function O(){if(d)return;const i=window.AudioContext||window.webkitAudioContext;d=new i,g=d.createOscillator(),g.type="square",g.frequency.setValueAtTime(440,d.currentTime),f=d.createGain(),f.gain.value=0,g.connect(f),f.connect(d.destination),g.start()}async function M(i){console.log(`Tentando carregar: ${i}`),E&&cancelAnimationFrame(E),o.pc=512,o.I=0,o.stack=new Array(16).fill(0),o.stackPointer=0,o.registers.fill(0),o.memory.fill(0),o.display.fill(0);try{const e=await fetch(`./roms/${i}.ch8`);if(console.log(`Fetch response: ${e.status} ${e.statusText}`),!e.ok)throw new Error(`Failed to load ROM: ${e.statusText}`);const s=await e.arrayBuffer();o.loadRom(new Uint8Array(s)),b=performance.now(),S(b),x.blur()}catch(e){console.error("Error loading ROM:",e),alert("Failed to load ROM. See console for details.")}}function S(i){E=requestAnimationFrame(S);const e=i-b;if(e>A){b=i-e%A;for(let s=0;s<10;s++)o.cycle();o.delayTimer>0&&o.delayTimer--,o.soundTimer>0&&o.soundTimer--,f&&(o.soundTimer>0?f.gain.value=.1:f.gain.value=0),U()}}function U(){p.fillStyle="black",p.fillRect(0,0,w.width,w.height),p.fillStyle="lime";for(let i=0;i<32;i++)for(let e=0;e<64;e++)o.display[i*64+e]&&p.fillRect(e*k,i*k,k,k)}let c={1:1,2:2,3:3,4:12,q:4,w:5,e:6,r:13,a:7,s:8,d:9,f:14,z:10,x:0,c:11,v:15};function q(i){return Object.keys(c).find(e=>c[e]===i)?.toUpperCase()||"---"}document.addEventListener("keydown",i=>{const e=i.key.toLowerCase();c[e]!==void 0&&(o.keys[c[e]]=1)});document.addEventListener("keyup",i=>{const e=i.key.toLowerCase();c[e]!==void 0&&(o.keys[c[e]]=0)});const P=document.getElementById("config-modal"),$=document.getElementById("btn-config"),D=document.getElementById("btn-close-config"),C=document.getElementById("mapping-list");$.addEventListener("click",()=>{B(),P.style.display="flex"});D.addEventListener("click",()=>{P.style.display="none",localStorage.setItem("chip8-keymap",JSON.stringify(c))});function B(){C.innerHTML="",[1,2,3,12,4,5,6,13,7,8,9,14,10,0,11,15].forEach(e=>{const s=document.createElement("div");s.className="map-row";const r=document.createElement("span");r.innerText=`Chip-8 Key [${e.toString(16).toUpperCase()}]`;const t=document.createElement("button");t.innerText=q(e),t.addEventListener("click",()=>{t.innerText="Aperte uma tecla...";const n=h=>{h.preventDefault();const m=h.key.toLowerCase();c[m]!==void 0&&delete c[m];const u=Object.keys(c).find(v=>c[v]===e);u&&delete c[u],c[m]=e,B(),document.removeEventListener("keydown",n)};document.addEventListener("keydown",n)}),s.appendChild(r),s.appendChild(t),C.appendChild(s)})}const T=localStorage.getItem("chip8-keymap");T&&(c=JSON.parse(T));const G=document.querySelectorAll("#mobile-keypad button");G.forEach(i=>{const e=i,s=parseInt(e.getAttribute("data-k"),16),r=n=>{n.preventDefault(),o.keys[s]=1,e.classList.add("active"),O()},t=n=>{n.preventDefault(),o.keys[s]=0,e.classList.remove("active")};e.addEventListener("mousedown",r),e.addEventListener("mouseup",t),e.addEventListener("mouseleave",t),e.addEventListener("touchstart",r,{passive:!1}),e.addEventListener("touchend",t,{passive:!1})});M("IBM_LOGO");
