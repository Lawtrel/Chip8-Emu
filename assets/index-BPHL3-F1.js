(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function t(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(s){if(s.ep)return;s.ep=!0;const c=t(s);fetch(s.href,c)}})();class C{memory=new Uint8Array(4096);registers=new Uint8Array(16);I=0;pc=512;stack=new Array(16).fill(0);stackPointer=0;keys=new Uint8Array(16);delayTimer=0;soundTimer=0;display=new Array(2048).fill(0);loadRom(e){for(let s=0;s<e.length;s++)this.memory[512+s]=e[s];const a=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];for(let s=0;s<a.length;s++)this.memory[s]=a[s]}cycle(){const e=this.memory[this.pc]<<8|this.memory[this.pc+1];switch(this.pc+=2,e&61440){case 0:(e&255)===224?this.display.fill(0):(e&255)===238&&(this.stackPointer--,this.pc=this.stack[this.stackPointer]);break;case 4096:this.pc=e&4095;break;case 8192:this.stack[this.stackPointer]=this.pc,this.stackPointer++,this.pc=e&4095;break;case 12288:this.registers[(e&3840)>>8]===(e&255)&&(this.pc+=2);break;case 16384:this.registers[(e&3840)>>8]!==(e&255)&&(this.pc+=2);break;case 20480:this.registers[(e&3840)>>8]===this.registers[(e&240)>>4]&&(this.pc+=2);break;case 24576:this.registers[(e&3840)>>8]=e&255;break;case 28672:this.registers[(e&3840)>>8]+=e&255;break;case 32768:const t=(e&3840)>>8,a=(e&240)>>4;switch(e&15){case 0:this.registers[t]=this.registers[a];break;case 1:this.registers[t]|=this.registers[a];break;case 2:this.registers[t]&=this.registers[a];break;case 3:this.registers[t]^=this.registers[a];break;case 4:const i=this.registers[t]+this.registers[a];this.registers[15]=i>255?1:0,this.registers[t]=i&255;break;case 5:this.registers[15]=this.registers[t]>this.registers[a]?1:0,this.registers[t]-=this.registers[a];break;case 6:this.registers[15]=this.registers[t]&1,this.registers[t]>>=1;break;case 7:this.registers[15]=this.registers[a]>this.registers[t]?1:0,this.registers[t]=this.registers[a]-this.registers[t];break;case 14:this.registers[15]=(this.registers[t]&128)>>7,this.registers[t]<<=1;break}break;case 36864:this.registers[(e&3840)>>8]!==this.registers[(e&240)>>4]&&(this.pc+=2);break;case 40960:this.I=e&4095;break;case 45056:this.pc=(e&4095)+this.registers[0];break;case 49152:const s=(e&3840)>>8;this.registers[s]=Math.floor(Math.random()*256)&(e&255);break;case 53248:const c=(e&3840)>>8,d=(e&240)>>4,L=e&15,P=this.registers[c],E=this.registers[d];this.registers[15]=0;for(let i=0;i<L;i++){const O=this.memory[this.I+i];for(let g=0;g<8;g++)if((O&128>>g)!==0){const w=(P+g)%64+(E+i)%32*64;this.display[w]===1&&(this.registers[15]=1),this.display[w]^=1}}break;case 57344:const b=(e&3840)>>8;(e&255)===158?this.keys[this.registers[b]]===1&&(this.pc+=2):(e&255)===161&&this.keys[this.registers[b]]===0&&(this.pc+=2);break;case 61440:const n=(e&3840)>>8;switch(e&255){case 7:this.registers[n]=this.delayTimer;break;case 21:this.delayTimer=this.registers[n];break;case 24:this.soundTimer=this.registers[n];break;case 30:this.I+=this.registers[n];break;case 41:this.I=this.registers[n]*5;break;case 51:this.memory[this.I]=Math.floor(this.registers[n]/100),this.memory[this.I+1]=Math.floor(this.registers[n]%100/10),this.memory[this.I+2]=this.registers[n]%10;break;case 85:for(let i=0;i<=n;i++)this.memory[this.I+i]=this.registers[i];break;case 101:for(let i=0;i<=n;i++)this.registers[i]=this.memory[this.I+i];break}break}}}const k=document.getElementById("screen"),m=k.getContext("2d"),y=10,o=new C;let p,u=0;const M=60,A=1e3/M;let l=null,f=null,h=null;const R=document.getElementById("romSelect"),I=document.getElementById("btnLoad");I.addEventListener("click",()=>{S(),l&&l.state==="suspended"&&l.resume();const r=R.value;v(r)});function S(){if(l)return;const r=window.AudioContext||window.webkitAudioContext;l=new r,f=l.createOscillator(),f.type="square",f.frequency.setValueAtTime(440,l.currentTime),h=l.createGain(),h.gain.value=0,f.connect(h),h.connect(l.destination),f.start()}async function v(r){p&&cancelAnimationFrame(p),o.pc=512,o.I=0,o.stack=new Array(16).fill(0),o.stackPointer=0,o.registers.fill(0),o.memory.fill(0),o.display.fill(0);try{const e=await fetch(`./roms/${r}.ch8`);if(!e.ok)throw new Error(`Failed to load ROM: ${e.statusText}`);const t=await e.arrayBuffer();o.loadRom(new Uint8Array(t)),u=performance.now(),T(u),I.blur()}catch(e){console.error("Error loading ROM:",e),alert("Failed to load ROM. See console for details.")}}function T(r){p=requestAnimationFrame(T);const e=r-u;if(e>A){u=r-e%A;for(let t=0;t<10;t++)o.cycle();o.delayTimer>0&&o.delayTimer--,o.soundTimer>0&&o.soundTimer--,h&&(o.soundTimer>0?h.gain.value=.1:h.gain.value=0),F()}}function F(){m.fillStyle="black",m.fillRect(0,0,k.width,k.height),m.fillStyle="lime";for(let r=0;r<32;r++)for(let e=0;e<64;e++)o.display[r*64+e]&&m.fillRect(e*y,r*y,y,y)}const x={1:1,2:2,3:3,4:12,q:4,w:5,e:6,r:13,a:7,s:8,d:9,f:14,z:10,x:0,c:11,v:15};document.addEventListener("keydown",r=>{const e=x[r.key.toLowerCase()];e!==void 0&&(o.keys[e]=1)});document.addEventListener("keyup",r=>{const e=x[r.key.toLowerCase()];e!==void 0&&(o.keys[e]=0)});v("PONG");
